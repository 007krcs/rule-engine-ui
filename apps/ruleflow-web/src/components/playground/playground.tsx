'use client';import { useEffect, useMemo, useState } from 'react';import type { ApiMapping, ExecutionContext, FlowSchema, JSONValue, Rule, UISchema } from '@platform/schema';import { executeStep } from '@platform/core-runtime';import { RenderPage } from '@platform/react-renderer';import { registerMaterialAdapters } from '@platform/react-material-adapter';import { registerAgGridAdapter } from '@platform/react-aggrid-adapter';import { registerHighchartsAdapter } from '@platform/react-highcharts-adapter';import { registerD3Adapter } from '@platform/react-d3-adapter';import { registerCompanyAdapter } from '@platform/react-company-adapter';import {  createProviderFromBundles,  EXAMPLE_TENANT_BUNDLES,  PLATFORM_BUNDLES,} from '@platform/i18n';import { flows } from '@/lib/mock-data';import { Button } from '@/components/ui/button';import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';import { Input } from '@/components/ui/input';import exampleUi from '@platform/schema/examples/example.ui.json';import exampleFlow from '@platform/schema/examples/example.flow.json';import exampleRules from '@platform/schema/examples/example.rules.json';import exampleApi from '@platform/schema/examples/example.api.json';const initialContext: ExecutionContext = {  tenantId: 'tenant-1',  userId: 'user-1',  role: 'admin',  roles: ['admin'],  country: 'US',  locale: 'en-US',  timezone: 'America/New_York',  device: 'desktop',  permissions: ['read'],  featureFlags: { demo: true },};const initialData: Record<string, JSONValue> = {  acceptedTerms: true,  formValid: true,  readyToSubmit: true,  orderTotal: 1200,  restricted: false,  orders: [],  revenueSeries: [],  customViz: [],};export function Playground() {  const flow = exampleFlow as unknown as FlowSchema;  const uiSchema = exampleUi as unknown as UISchema;  const rules = (exampleRules as unknown as { rules: Rule[] }).rules;  const apiMappingsById: Record<string, ApiMapping> = {    submitOrder: exampleApi as unknown as ApiMapping,  };  const [stateId, setStateId] = useState(flow.initialState);  const [context, setContext] = useState<ExecutionContext>(initialContext);  const [data, setData] = useState<Record<string, JSONValue>>(initialData);  const [trace, setTrace] = useState<unknown>(null);  const [selectedFlow, setSelectedFlow] = useState(flows[0]?.id ?? 'flow-checkout');  useEffect(() => {    registerMaterialAdapters();    registerAgGridAdapter();    registerHighchartsAdapter();    registerD3Adapter();    registerCompanyAdapter();  }, []);  const uiSchemasById = useMemo<Record<string, UISchema>>(() => {    const map: Record<string, UISchema> = {};    for (const state of Object.values(flow.states)) {      map[state.uiPageId] = uiSchema;    }    return map;  }, [flow, uiSchema]);  const baseLocale = context.locale.split('-')[0] ?? context.locale;  const i18n = useMemo(    () =>      createProviderFromBundles({        locale: baseLocale,        fallbackLocale: 'en',        bundles: [...PLATFORM_BUNDLES, ...EXAMPLE_TENANT_BUNDLES],        mode: 'dev',      }),    [baseLocale],  );  const currentState = flow.states[stateId];  const currentUiSchema = currentState ? uiSchemasById[currentState.uiPageId] ?? uiSchema : uiSchema;  const runEvent = async (event: string) => {    const fetchFn = async () =>      new Response(JSON.stringify({ orderId: 'demo-1', status: 'submitted', requestId: 'req-1' }), {        status: 200,        headers: { 'content-type': 'application/json' },      });    const result = await executeStep({      flow,      uiSchemasById,      rules,      apiMappingsById,      stateId,      event,      context,      data,      fetchFn,    });    setStateId(result.nextStateId);    setContext(result.updatedContext);    setData(result.updatedData as Record<string, JSONValue>);    setTrace(result.trace);  };  return (    <div className="grid gap-6 lg:grid-cols-[320px_1fr_360px]">      <Card>        <CardHeader>          <CardTitle>Context Simulator</CardTitle>        </CardHeader>        <CardContent className="space-y-4">          <div>            <label className="text-xs font-semibold text-muted-foreground">Flow</label>            <select              className="mt-1 h-10 w-full rounded-lg border border-border bg-surface px-3 text-sm"              value={selectedFlow}              onChange={(event) => setSelectedFlow(event.target.value)}            >              {flows.map((flowItem) => (                <option key={flowItem.id} value={flowItem.id}>                  {flowItem.name} v{flowItem.version}                </option>              ))}            </select>          </div>          <div>            <label className="text-xs font-semibold text-muted-foreground">Role</label>            <Input value={context.role} onChange={(event) => setContext({ ...context, role: event.target.value })} />          </div>          <div>            <label className="text-xs font-semibold text-muted-foreground">Country</label>            <Input              value={context.country}              onChange={(event) => setContext({ ...context, country: event.target.value as ExecutionContext['country'] })}            />          </div>          <div>            <label className="text-xs font-semibold text-muted-foreground">Device</label>            <select              className="mt-1 h-10 w-full rounded-lg border border-border bg-surface px-3 text-sm"              value={context.device}              onChange={(event) =>                setContext({ ...context, device: event.target.value as ExecutionContext['device'] })              }            >              <option value="desktop">Desktop</option>              <option value="tablet">Tablet</option>              <option value="mobile">Mobile</option>            </select>          </div>          <div>            <label className="text-xs font-semibold text-muted-foreground">Locale</label>            <Input              value={context.locale}              onChange={(event) => setContext({ ...context, locale: event.target.value })}            />          </div>          <div className="flex flex-wrap gap-2">            <Button size="sm" onClick={() => runEvent('back')}>              Back            </Button>            <Button size="sm" onClick={() => runEvent('next')}>              Next            </Button>            <Button size="sm" onClick={() => runEvent('submit')}>              Submit            </Button>          </div>        </CardContent>      </Card>      <Card>        <CardHeader>          <CardTitle>Rendered UI</CardTitle>        </CardHeader>        <CardContent>          <RenderPage uiSchema={currentUiSchema} data={data} context={context} i18n={i18n} />        </CardContent>      </Card>      <Card>        <CardHeader>          <CardTitle>Trace</CardTitle>        </CardHeader>        <CardContent>          <pre className="max-h-[520px] overflow-auto rounded-lg bg-muted/40 p-3 text-xs">            {JSON.stringify(trace, null, 2)}          </pre>        </CardContent>      </Card>    </div>  );}